{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard | Spiritual G-Code{% endblock %}

{% block extra_css %}
<style>
    .score-circle {
        position: relative;
        width: 200px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: conic-gradient(
            var(--score-color) 0deg,
            var(--score-color) calc(var(--score) * 3.6deg),
            #161b22 calc(var(--score) * 3.6deg),
            #161b22 360deg
        );
        box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
    }

    .score-circle::before {
        content: '';
        position: absolute;
        width: 180px;
        height: 180px;
        border-radius: 50%;
        background: #0D1117;
    }

    .score-value {
        position: relative;
        z-index: 1;
        font-size: 3rem;
        font-weight: bold;
    }

    .theme-tag {
        background: rgba(0, 255, 65, 0.1);
        border: 1px solid rgba(0, 255, 65, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
    }

    .card {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 0.75rem;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }

    .card:hover {
        border-color: #00FF41;
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
    }

    .intensity-low { --score-color: #00B82D; }
    .intensity-medium { --score-color: #00FF41; }
    .intensity-high { --score-color: #F4D03F; }
    .intensity-intense { --score-color: #FF5A5F; }

    /* Chart Action Buttons */
    .chart-action-btn {
        padding: 6px 8px;
        background: rgba(0, 255, 65, 0.1);
        border: 1px solid rgba(0, 255, 65, 0.3);
        border-radius: 4px;
        color: #00FF41;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s;
    }

    .chart-action-btn:hover {
        background: rgba(0, 255, 65, 0.2);
        border-color: #00FF41;
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
    }

    .chart-action-btn:active {
        transform: scale(0.95);
    }

    /* Global Action Buttons */
    .global-action-btn {
        padding: 8px 16px;
        background: rgba(0, 255, 65, 0.1);
        border: 1px solid rgba(0, 255, 65, 0.3);
        border-radius: 6px;
        color: #00FF41;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .global-action-btn:hover {
        background: rgba(0, 255, 65, 0.2);
        border-color: #00FF41;
        box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
    }

    .global-action-btn:active {
        transform: scale(0.98);
    }

    /* WebSocket Status Indicator */
    .ws-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .ws-connected {
        background: #00FF41;
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.6);
    }

    .ws-disconnected {
        background: #FF5A5F;
        box-shadow: 0 0 10px rgba(255, 90, 95, 0.4);
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }

    /* Comparison Mode Styles */
    .comparison-controls {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #30363d;
    }

    .comparison-date-ranges {
        margin-top: 1rem;
        padding: 1rem;
        background: #0D1117;
        border: 1px solid #30363d;
        border-radius: 6px;
    }

    .comparison-date-input {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 4px;
        color: #c9d1d9;
        padding: 6px 10px;
        font-size: 13px;
        flex: 1;
    }

    .comparison-date-input:focus {
        outline: none;
        border-color: #00FF41;
        box-shadow: 0 0 0 3px rgba(0, 255, 65, 0.1);
    }

    .comparison-actions {
        display: flex;
        gap: 0.75rem;
    }

    .comparison-wrapper {
        margin-bottom: 1.5rem;
    }

    .comparison-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .comparison-header h3 {
        color: #00FF41;
        margin: 0;
        font-size: 1.25rem;
    }

    .comparison-periods {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .period-label {
        color: #8B949E;
        font-size: 0.875rem;
    }

    .period-label strong {
        color: #c9d1d9;
    }

    .period-date {
        color: #00FF41;
        font-family: 'Courier New', monospace;
    }

    .comparison-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
    }

    .comparison-chart {
        background: #0D1117;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 1rem;
    }

    .comparison-chart-title {
        color: #c9d1d9;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        text-align: center;
    }

    .comparison-statistics {
        margin-bottom: 1.5rem;
    }

    .comparison-statistics h3 {
        color: #00FF41;
        margin-bottom: 1rem;
    }

    .statistics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        align-items: start;
    }

    .stat-group {
        padding: 1rem;
        background: #0D1117;
        border: 1px solid #30363d;
        border-radius: 6px;
    }

    .stat-group h4 {
        color: #58A6FF;
        margin: 0 0 1rem 0;
        font-size: 1rem;
    }

    .stat-label {
        color: #8B949E;
        font-size: 0.75rem;
        margin: 0.5rem 0 0.25rem 0;
    }

    .stat-value {
        color: #c9d1d9;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
        font-family: 'Courier New', monospace;
    }

    .stat-divider {
        width: 1px;
        background: #30363d;
        align-self: stretch;
    }

    .stat-diff {
        background: rgba(0, 255, 65, 0.05);
        border-color: #00FF41;
    }

    .text-gcode-green {
        color: #00FF41 !important;
    }

    .text-red-500 {
        color: #FF5A5F !important;
    }

    .text-yellow-500 {
        color: #F4D03F !important;
    }

    .text-blue-500 {
        color: #58A6FF !important;
    }

    .text-gray-400 {
        color: #8B949E !important;
    }

    .chart-error {
        color: #FF5A5F;
        text-align: center;
        padding: 2rem;
        font-size: 0.875rem;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .chart-action-btn {
            min-width: 40px;
            min-height: 40px;
            padding: 8px;
        }

        .chart-action-btn svg {
            width: 18px;
            height: 18px;
        }

        .global-action-btn {
            padding: 10px 14px;
            font-size: 13px;
        }

        /* Larger touch targets for mobile */
        input[type="date"],
        select {
            padding: 10px 12px;
            font-size: 16px; /* Prevents iOS zoom on focus */
            min-height: 44px;
        }

        /* Better spacing for mobile customization controls */
        .card.p-4 .flex.flex-wrap {
            flex-direction: column;
            align-items: stretch;
        }

        .card.p-4 .flex.flex-wrap > div {
            width: 100%;
            margin-bottom: 1rem;
        }

        /* Checkbox labels more touch-friendly */
        label {
            padding: 8px 12px;
            margin: 4px;
        }

        label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Chart cards take full width on mobile */
        #chart-trend,
        #chart-planetary,
        #chart-element,
        #chart-forecast,
        #chart-network {
            width: 100%;
        }

        /* Charts grid becomes single column on mobile */
        .grid.grid-cols-1.lg\\:grid-cols-2 {
            grid-template-columns: 1fr;
        }
    }

    /* Touch-friendly hover states for mobile */
    @media (hover: none) and (pointer: coarse) {
        .chart-action-btn:hover,
        .global-action-btn:hover {
            background: rgba(0, 255, 65, 0.1);
        }

        .chart-action-btn:active,
        .global-action-btn:active {
            background: rgba(0, 255, 65, 0.3);
            transform: scale(0.95);
        }
    }
</style>
<link rel="stylesheet" href="{% static 'css/components/annotations.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">
                <span class="terminal-text">root@spiritual-gcode</span>:~# ./dashboard.sh
            </h1>
            <p id="cosmic-status" class="text-gray-400 typing-cursor">Loading cosmic data...</p>
        </div>
        <div class="flex items-center gap-4">
            <a href="{% url 'wheel' %}" class="global-action-btn" style="text-decoration: none;">
                ðŸŒ™ View Natal Wheel
            </a>
            <a href="{% url 'solar-system' %}" class="global-action-btn" style="text-decoration: none;">
                ðŸŒŒ Solar System
            </a>
            <div id="ws-status-indicator" class="ws-status ws-disconnected" title="WebSocket connection status">
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="dashboard-loading" class="flex flex-col items-center justify-center py-20">
        <div class="w-64 h-2 bg-gcode-border rounded-full overflow-hidden">
            <div class="loading-bar h-full rounded-full"></div>
        </div>
        <p class="mt-4 text-gcode-green text-sm">Initializing G-Code system...</p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-content" class="hidden space-y-8">
        <!-- Today's G-Code Hero Section -->
        <section class="card card-glow">
            <div class="flex flex-col lg:flex-row gap-8 items-center justify-between">
                <!-- Left: Score Circle -->
                <div class="flex-shrink-0">
                    <div id="score-circle" class="score-circle intensity-low">
                        <div class="score-value terminal-text">--</div>
                    </div>
                    <p class="text-center text-gray-400 mt-4 text-sm">G-CODE INTENSITY</p>
                </div>

                <!-- Middle: Today's Details -->
                <div class="flex-1 space-y-6 w-full">
                    <!-- Theme -->
                    <div>
                        <h3 class="text-xs text-gray-500 mb-2">TODAY'S THEME</h3>
                        <p id="today-theme" class="text-2xl font-bold text-white">Loading...</p>
                    </div>

                    <!-- Themes Tags -->
                    <div>
                        <h3 class="text-xs text-gray-500 mb-2">KEY THEMES</h3>
                        <div id="themes-container" class="flex flex-wrap gap-2">
                            <span class="theme-tag text-gcode-green">#Loading...</span>
                        </div>
                    </div>

                    <!-- Affirmation -->
                    <div>
                        <h3 class="text-xs text-gray-500 mb-2">DAILY AFFIRMATION</h3>
                        <p id="today-affirmation" class="text-lg italic text-gray-300">Loading...</p>
                    </div>

                    <!-- Practical Guidance -->
                    <div>
                        <h3 class="text-xs text-gray-500 mb-2">PRACTICAL GUIDANCE</h3>
                        <ul id="guidance-list" class="space-y-2">
                            <li class="flex items-start text-gray-400">
                                <span class="terminal-text mr-2">â–¸</span>
                                <span>Loading guidance...</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Right: Quick Stats -->
                <div class="flex-shrink-0 w-full lg:w-64 space-y-4">
                    <div class="bg-gcode-bg rounded-lg p-4 border border-gcode-border">
                        <h4 class="text-xs text-gray-500 mb-1">SUN SIGN</h4>
                        <p id="sun-sign" class="text-xl font-bold text-white">--</p>
                    </div>

                    <div class="bg-gcode-bg rounded-lg p-4 border border-gcode-border">
                        <h4 class="text-xs text-gray-500 mb-1">MOON SIGN</h4>
                        <p id="moon-sign" class="text-xl font-bold text-white">--</p>
                    </div>

                    <div class="bg-gcode-bg rounded-lg p-4 border border-gcode-border">
                        <h4 class="text-xs text-gray-500 mb-1">ASCENDANT</h4>
                        <p id="ascendant" class="text-xl font-bold text-white">--</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Weekly Forecast -->
            <section class="card">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i data-lucide="calendar" class="w-5 h-5 mr-2 terminal-text"></i>
                        Weekly Forecast
                    </h2>
                    <span class="text-xs text-gray-500">Next 7 days</span>
                </div>

                <div id="weekly-forecast" class="space-y-4">
                    <!-- Weekly items will be loaded here -->
                    <div class="text-center py-8 text-gray-500">
                        <div class="loading-bar w-48 h-2 mx-auto rounded-full mb-4"></div>
                        <p class="text-sm">Calculating transits...</p>
                    </div>
                </div>
            </section>

            <!-- Recent Content -->
            <section class="card">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i data-lucide="file-text" class="w-5 h-5 mr-2 terminal-text"></i>
                        Recent Content
                    </h2>
                    <a href="{% url 'content' %}" class="text-xs text-gcode-green hover:underline">View All â†’</a>
                </div>

                <div id="recent-content" class="space-y-4">
                    <!-- Content items will be loaded here -->
                    <div class="text-center py-8 text-gray-500">
                        <div class="loading-bar w-48 h-2 mx-auto rounded-full mb-4"></div>
                        <p class="text-sm">Loading content...</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- User Stats -->
        <section class="card">
            <h2 class="text-xl font-bold text-white mb-6 flex items-center">
                <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2 terminal-text"></i>
                Your G-Code Statistics
            </h2>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="user-stats">
                <div class="bg-gcode-bg rounded-lg p-4 border border-gcode-border text-center">
                    <p id="stat-transits" class="text-3xl font-bold terminal-text">--</p>
                    <p class="text-xs text-gray-500 mt-1">Total Transits</p>
                </div>

                <div class="bg-gcode-bg rounded-lg p-4 border border-gcode-border text-center">
                    <p id="stat-content" class="text-3xl font-bold terminal-text">--</p>
                    <p class="text-xs text-gray-500 mt-1">Content Generated</p>
                </div>

                <div class="bg-gcode-bg rounded-lg p-4 border border-gcode-border text-center">
                    <p id="stat-avg-score" class="text-3xl font-bold terminal-text">--</p>
                    <p class="text-xs text-gray-500 mt-1">Avg G-Code Score</p>
                </div>

                <div class="bg-gcode-bg rounded-lg p-4 border border-gcode-border text-center">
                    <p id="stat-days" class="text-3xl font-bold terminal-text">--</p>
                    <p class="text-xs text-gray-500 mt-1">Days on G-Code</p>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="space-y-8">
            <!-- Customization Controls -->
            <div class="card p-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-400">Date Range:</span>
                        <div class="flex items-center gap-2">
                            <input type="date" id="date-range-start" class="bg-gcode-bg border border-gcode-border rounded px-3 py-2 text-sm text-gcode-green focus:outline-none focus:border-gcode-green" onchange="applyDateRange()">
                            <span class="text-gray-500">to</span>
                            <input type="date" id="date-range-end" class="bg-gcode-bg border border-gcode-border rounded px-3 py-2 text-sm text-gcode-green focus:outline-none focus:border-gcode-green" onchange="applyDateRange()">
                            <button onclick="resetDateRange()" class="global-action-btn">Reset</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-400">Show Charts:</span>
                        <div class="flex flex-wrap gap-3">
                            <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input type="checkbox" checked onchange="toggleChart('trend', this.checked)" class="accent-green-500">
                                Trend
                            </label>
                            <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input type="checkbox" checked onchange="toggleChart('planetary', this.checked)" class="accent-green-500">
                                Planetary
                            </label>
                            <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input type="checkbox" checked onchange="toggleChart('element', this.checked)" class="accent-green-500">
                                Elements
                            </label>
                            <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input type="checkbox" checked onchange="toggleChart('forecast', this.checked)" class="accent-green-500">
                                Forecast
                            </label>
                            <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input type="checkbox" checked onchange="toggleChart('network', this.checked)" class="accent-green-500">
                                Network
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i data-lucide="activity" class="w-5 h-5 mr-2 terminal-text"></i>
                    G-Code Analytics
                </h2>
                <span class="text-xs text-gray-500">Real-time cosmic visualization</span>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- G-Code Trend Chart -->
                <div id="chart-trend" class="card card-glow p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-white">G-Code 7-Day Trend</h3>
                        <div class="chart-controls" data-chart="trend">
                            <button class="chart-action-btn" onclick="window.chartManager.refreshChart('trend')" title="Refresh">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                            <button class="chart-action-btn" onclick="window.ChartExportUtils.exportChartAsPNG('gcode-trend-chart', 'gcode-trend.png')" title="Export PNG">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l4-4m-4 4h8"></path></svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mb-4">Your cosmic energy patterns over the last week</p>
                    <div class="h-80">
                        <canvas id="gcode-trend-chart"></canvas>
                    </div>
                </div>

                <!-- Planetary Positions Chart -->
                <div id="chart-planetary" class="card card-glow p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-white">Planetary Positions</h3>
                        <div class="chart-controls" data-chart="planetary">
                            <button class="chart-action-btn" onclick="window.chartManager.refreshChart('planetary')" title="Refresh">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                            <button class="chart-action-btn" onclick="window.ChartExportUtils.exportChartAsPNG('planetary-chart', 'planetary-positions.png')" title="Export PNG">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l4-4m-4 4h8"></path></svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mb-4">Current zodiac positions of celestial bodies</p>
                    <div class="h-80">
                        <canvas id="planetary-chart"></canvas>
                    </div>
                </div>

                <!-- Element Distribution Chart -->
                <div id="chart-element" class="card card-glow p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-white">Element Distribution</h3>
                        <div class="chart-controls" data-chart="element">
                            <button class="chart-action-btn" onclick="window.chartManager.refreshChart('element')" title="Refresh">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                            <button class="chart-action-btn" onclick="window.ChartExportUtils.exportChartAsPNG('element-chart', 'element-distribution.png')" title="Export PNG">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l4-4m-4 4h8"></path></svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mb-4">Balance of Fire, Earth, Air, and Water in your chart</p>
                    <div class="h-80">
                        <canvas id="element-chart"></canvas>
                    </div>
                </div>

                <!-- Weekly Forecast Chart -->
                <div id="chart-forecast" class="card card-glow p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-white">7-Day Forecast</h3>
                        <div class="chart-controls" data-chart="forecast">
                            <button class="chart-action-btn" onclick="window.chartManager.refreshChart('forecast')" title="Refresh">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                            <button class="chart-action-btn" onclick="window.ChartExportUtils.exportChartAsPNG('forecast-chart', 'weekly-forecast.png')" title="Export PNG">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l4-4m-4 4h8"></path></svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mb-4">Predicted G-Code intensity for the coming week</p>
                    <div class="h-80">
                        <canvas id="forecast-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Aspects Network Chart - Full Width -->
            <div id="chart-network" class="card card-glow p-6 mt-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-bold text-white">Planetary Aspects Network</h3>
                    <div class="chart-controls" data-chart="network">
                        <button class="chart-action-btn" onclick="window.chartManager.refreshChart('network')" title="Refresh">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                        <button class="chart-action-btn" onclick="window.chartManager.exportNetwork('png')" title="Export PNG">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l4-4m-4 4h8"></path></svg>
                        </button>
                        <button class="chart-action-btn" onclick="window.chartManager.exportNetwork('svg')" title="Export SVG">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4 4m0 0l4-4m-4 4h8"></path></svg>
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mb-4">Interactive view of planetary aspect relationships (drag nodes, scroll to zoom)</p>
                <div id="aspects-network-chart" style="height: 500px; width: 100%;"></div>
            </div>

            <!-- Global Actions Bar -->
            <div class="card p-4 mt-6">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Global Actions:</span>
                        <button onclick="window.chartManager.refreshAll()" class="global-action-btn">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            Refresh All Charts
                        </button>
                        <div class="flex items-center gap-2 border-l border-gcode-border pl-3">
                            <span class="text-sm text-gray-400">Auto-refresh:</span>
                            <button id="auto-refresh-toggle" onclick="toggleAutoRefresh()" class="global-action-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span id="auto-refresh-text">Enable</span>
                            </button>
                            <select id="auto-refresh-interval" onchange="setAutoRefreshInterval(this.value)" class="bg-gcode-bg border border-gcode-border rounded px-2 py-1 text-sm text-gcode-green focus:outline-none focus:border-gcode-green">
                                <option value="1">1 min</option>
                                <option value="5" selected>5 min</option>
                                <option value="10">10 min</option>
                                <option value="15">15 min</option>
                                <option value="30">30 min</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Export All:</span>
                        <button onclick="window.ChartExportUtils.exportAllCharts(window.chartManager, 'png')" class="global-action-btn">
                            Export PNGs
                        </button>
                        <button onclick="window.ChartExportUtils.exportAllCharts(window.chartManager, 'svg')" class="global-action-btn">
                            Export SVGs
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js Components -->
<script src="{% static 'js/components/charts/chart-utils.js' %}"></script>
<script src="{% static 'js/components/charts/export-utils.js' %}"></script>
<script src="{% static 'js/components/charts/trend-chart.js' %}"></script>
<script src="{% static 'js/components/charts/planetary-chart.js' %}"></script>
<script src="{% static 'js/components/charts/element-chart.js' %}"></script>
<script src="{% static 'js/components/charts/forecast-chart.js' %}"></script>
<script src="{% static 'js/components/charts/aspects-network-chart.js' %}"></script>
<script src="{% static 'js/components/charts/chart-manager.js' %}"></script>

<!-- WebSocket Components -->
<script src="{% static 'js/components/websocket/dashboard-client.js' %}"></script>

<!-- Annotation Components -->
<script src="{% static 'js/components/annotations/annotation-manager.js' %}"></script>
<script src="{% static 'js/components/annotations/annotation-ui.js' %}"></script>

<!-- Comparison Components -->
<script src="{% static 'js/components/comparison/date-range-picker.js' %}"></script>
<script src="{% static 'js/components/comparison/chart-comparator.js' %}"></script>

<script>
// Dashboard JavaScript
document.addEventListener('DOMContentLoaded', async function() {
    // Initialize Lucide icons
    lucide.createIcons();

    // Mobile menu toggle
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');

    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
    }

    try {
        console.log('[Dashboard] Starting initialization...');
        // Fetch dashboard data
        console.log('[Dashboard] Fetching data from /api/dashboard/overview/...');
        const response = await fetch('/api/dashboard/overview/');
        if (!response.ok) throw new Error('Failed to fetch dashboard data');

        const data = await response.json();
        console.log('[Dashboard] Data received:', data);

        // Update cosmic status text
        const statusEl = document.getElementById('cosmic-status');
        if (statusEl) {
            if (data.today_gcode) {
                statusEl.textContent = `âœ“ Cosmic data loaded for ${new Date().toLocaleDateString()}`;
                statusEl.classList.remove('typing-cursor');
                statusEl.classList.add('text-gcode-green');
            } else {
                statusEl.textContent = 'âš  No cosmic data available - Calculate your natal chart to see daily transits';
                statusEl.classList.remove('typing-cursor');
                statusEl.classList.add('text-yellow-500');
            }
        }

        // Hide loading, show content (do this first)
        console.log('[Dashboard] Hiding loading, showing content...');
        const loadingEl = document.getElementById('dashboard-loading');
        const contentEl = document.getElementById('dashboard-content');
        if (loadingEl) loadingEl.classList.add('hidden');
        if (contentEl) contentEl.classList.remove('hidden');
        console.log('[Dashboard] Loading hidden, content shown');

        // Update today's G-Code
        if (data.today_gcode) {
            console.log('[Dashboard] Updating today\'s G-Code...');
            updateTodayGCode(data.today_gcode);
        }

        // Update weekly forecast
        if (data.weekly_transits && data.weekly_transits.length > 0) {
            console.log('[Dashboard] Updating weekly forecast...');
            updateWeeklyForecast(data.weekly_transits);
        }

        // Update recent content
        if (data.recent_content && data.recent_content.length > 0) {
            console.log('[Dashboard] Updating recent content...');
            updateRecentContent(data.recent_content);
        }

        // Update user stats
        if (data.user_stats) {
            console.log('[Dashboard] Updating user stats...');
            updateUserStats(data.user_stats);
        }

        // Update natal chart signs
        if (data.natal_chart) {
            console.log('[Dashboard] Updating natal chart signs...');
            updateNatalChartSigns(data.natal_chart);
        }

        // Initialize Charts
        if (window.DashboardChartsManager) {
            console.log('[Dashboard] Initializing charts...');
            window.chartManager = new window.DashboardChartsManager();
            await window.chartManager.initAll();
            console.log('[Dashboard] Charts initialized');
        }

        // Initialize WebSocket for real-time updates
        if (window.initDashboardWebSocket) {
            console.log('[Dashboard] Initializing WebSocket...');
            initDashboardWebSocket();
        }

        // Initialize Annotation system
        if (window.annotationUI && window.annotationManager) {
            console.log('[Dashboard] Initializing annotation system...');
            // Preload annotations for all chart types
            const chartTypes = ['gcode_trend', 'planetary', 'element', 'forecast', 'network'];
            for (const chartType of chartTypes) {
                try {
                    await window.annotationManager.preloadAnnotations(chartType);
                } catch (error) {
                    console.warn(`Failed to preload annotations for ${chartType}:`, error);
                }
            }
            console.log('âœ“ Annotation system initialized');

            // Enable annotations on all charts
            if (window.chartManager) {
                await window.chartManager.enableAllAnnotations();
            }
        }

        console.log('[Dashboard] âœ“ Initialization complete!');

    } catch (error) {
        console.error('[Dashboard] Error loading dashboard:', error);
        console.error('[Dashboard] Error stack:', error.stack);
        showError('Failed to load dashboard data. Please try again.');
    }
});

function updateTodayGCode(gcode) {
    // Update score
    const score = gcode.g_code_score || 50;
    const scoreCircle = document.getElementById('score-circle');
    scoreCircle.querySelector('.score-value').textContent = score;

    // Set color based on score
    let intensityClass = 'intensity-low';
    if (score >= 80) intensityClass = 'intensity-intense';
    else if (score >= 60) intensityClass = 'intensity-high';
    else if (score >= 40) intensityClass = 'intensity-medium';

    scoreCircle.classList.remove('intensity-low', 'intensity-medium', 'intensity-high', 'intensity-intense');
    scoreCircle.classList.add(intensityClass);

    // Update theme
    document.getElementById('today-theme').textContent = gcode.interpretation?.substring(0, 100) + '...' || 'No theme available';

    // Update themes
    const themesContainer = document.getElementById('themes-container');
    if (gcode.themes && gcode.themes.length > 0) {
        themesContainer.innerHTML = gcode.themes.map(theme =>
            `<span class="theme-tag text-gcode-green">${theme}</span>`
        ).join('');
    }

    // Update affirmation
    document.getElementById('today-affirmation').textContent = gcode.affirmation || 'Loading affirmation...';

    // Update guidance
    const guidanceList = document.getElementById('guidance-list');
    if (gcode.practical_guidance && gcode.practical_guidance.length > 0) {
        guidanceList.innerHTML = gcode.practical_guidance.map(guidance =>
            `<li class="flex items-start text-gray-400">
                <span class="terminal-text mr-2">â–¸</span>
                <span>${guidance}</span>
            </li>`
        ).join('');
    }
}

function updateWeeklyForecast(transits) {
    const container = document.getElementById('weekly-forecast');

    container.innerHTML = transits.map(transit => {
        const date = new Date(transit.transit_date);
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        let intensityColor = 'text-gcode-green';
        if (transit.intensity_level === 'high') intensityColor = 'text-gcode-yellow';
        if (transit.intensity_level === 'intense') intensityColor = 'text-gcode-red';

        return `
            <div class="flex items-center justify-between bg-gcode-bg rounded-lg p-3 border border-gcode-border hover:border-gcode-green transition-colors">
                <div class="flex items-center space-x-3">
                    <div class="text-center">
                        <p class="text-lg font-bold text-white">${dayName}</p>
                        <p class="text-xs text-gray-500">${dateStr}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-2xl font-bold ${intensityColor}">${transit.g_code_score}</p>
                    <p class="text-xs text-gray-500">${transit.intensity_level}</p>
                </div>
            </div>
        `;
    }).join('');
}

function updateRecentContent(contentItems) {
    const container = document.getElementById('recent-content');

    container.innerHTML = contentItems.map(item => {
        const date = new Date(item.generated_at);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        return `
            <div class="bg-gcode-bg rounded-lg p-3 border border-gcode-border hover:border-gcode-green transition-colors">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs text-gcode-green uppercase">${item.content_type}</span>
                    <span class="text-xs text-gray-500">${dateStr}</span>
                </div>
                <h4 class="text-sm font-bold text-white mb-1">${item.title}</h4>
                <p class="text-xs text-gray-400 line-clamp-2">${item.body.substring(0, 100)}...</p>
                <div class="mt-2 flex items-center justify-between">
                    <span class="text-xs text-gray-500">${item.platform}</span>
                    <span class="text-xs px-2 py-1 rounded ${
                        item.status === 'posted' ? 'bg-gcode-green/20 text-gcode-green' :
                        item.status === 'generated' ? 'bg-gcode-yellow/20 text-gcode-yellow' :
                        'bg-gray-700 text-gray-400'
                    }">${item.status}</span>
                </div>
            </div>
        `;
    }).join('');
}

function updateUserStats(stats) {
    document.getElementById('stat-transits').textContent = stats.total_transits || 0;
    document.getElementById('stat-content').textContent = stats.total_content || 0;
    document.getElementById('stat-avg-score').textContent = stats.avg_gcode_score || '--';
    document.getElementById('stat-days').textContent = Math.floor(stats.total_transits / 7) || 0;
}

function updateNatalChartSigns(natalChart) {
    const sunSignEl = document.getElementById('sun-sign');
    const moonSignEl = document.getElementById('moon-sign');
    const ascendantEl = document.getElementById('ascendant');

    if (sunSignEl && natalChart.sun_sign) {
        sunSignEl.textContent = natalChart.sun_sign;
    }
    if (moonSignEl && natalChart.moon_sign) {
        moonSignEl.textContent = natalChart.moon_sign;
    }
    if (ascendantEl && natalChart.ascendant) {
        ascendantEl.textContent = natalChart.ascendant;
    }

    console.log('[Dashboard] Natal chart signs updated:',
        'Sun:', natalChart.sun_sign,
        'Moon:', natalChart.moon_sign,
        'Ascendant:', natalChart.ascendant
    );
}

function showError(message) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'bg-gcode-red border border-gcode-red rounded-lg p-4 text-white shadow-lg';
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Auto-refresh functions
function toggleAutoRefresh() {
    if (!window.chartManager) return;

    const interval = parseInt(document.getElementById('auto-refresh-interval').value);
    const isEnabled = window.chartManager.toggleAutoRefresh(interval);

    const toggleBtn = document.getElementById('auto-refresh-toggle');
    const toggleText = document.getElementById('auto-refresh-text');

    if (isEnabled) {
        toggleBtn.style.background = 'rgba(0, 255, 65, 0.25)';
        toggleBtn.style.borderColor = '#00FF41';
        toggleText.textContent = 'Disable';
        console.log('âœ“ Auto-refresh enabled');
    } else {
        toggleBtn.style.background = '';
        toggleBtn.style.borderColor = '';
        toggleText.textContent = 'Enable';
        console.log('âœ“ Auto-refresh disabled');
    }
}

function setAutoRefreshInterval(minutes) {
    if (!window.chartManager) return;

    window.chartManager.setAutoRefreshInterval(parseInt(minutes));
    console.log(`âœ“ Auto-refresh interval set to ${minutes} minutes`);
}

// Date range functions
let customDateRange = null;

function applyDateRange() {
    const startDate = document.getElementById('date-range-start').value;
    const endDate = document.getElementById('date-range-end').value;

    if (!startDate || !endDate) {
        console.warn('Please select both start and end dates');
        return;
    }

    customDateRange = {
        start: startDate,
        end: endDate
    };

    console.log(`âœ“ Date range set: ${startDate} to ${endDate}`);

    // Refresh charts with new date range
    if (window.chartManager) {
        window.chartManager.refreshAll();
    }
}

function resetDateRange() {
    document.getElementById('date-range-start').value = '';
    document.getElementById('date-range-end').value = '';
    customDateRange = null;
    console.log('âœ“ Date range reset');

    // Refresh charts with default range
    if (window.chartManager) {
        window.chartManager.refreshAll();
    }
}

// Chart toggle function
function toggleChart(chartName, isVisible) {
    const chartElement = document.getElementById(`chart-${chartName}`);

    if (!chartElement) {
        console.error(`Chart element not found: chart-${chartName}`);
        return;
    }

    if (isVisible) {
        chartElement.style.display = '';
        console.log(`âœ“ Showing ${chartName} chart`);
    } else {
        chartElement.style.display = 'none';
        console.log(`âœ“ Hiding ${chartName} chart`);
    }
}
</script>
{% endblock %}
